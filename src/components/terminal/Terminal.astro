---
import type { Lang } from "@/utils/i18n";
import { useTranslations } from "@/utils/i18n";

interface Props {
    lang: Lang;
    terminalData: Record<string, string>;
}

const { lang, terminalData } = Astro.props;
const t = useTranslations(lang);
---

<div class="terminal glass" id="interactive-terminal">
    <div class="terminal-bar">
        <div class="terminal-buttons">
            <span class="terminal-btn close"></span>
            <span class="terminal-btn minimize"></span>
            <span class="terminal-btn maximize"></span>
        </div>
        <span class="terminal-title">jesus.valdemar@portfolio ~ %</span>
    </div>
    <div class="terminal-body" id="terminal-output">
        <div class="terminal-line">
            <span class="prompt">$</span>
            <span class="typed-text" id="auto-typed">whoami</span>
        </div>
        <div class="terminal-response" id="initial-response">
            <div set:html={terminalData["whoami"] || ""} />
        </div>
    </div>
    <div class="terminal-input-row">
        <span class="prompt">$</span>
        <input
            type="text"
            class="terminal-input"
            id="terminal-input"
            placeholder={t.terminal.placeholder}
            autocomplete="off"
            spellcheck="false"
        />
    </div>
</div>

<script is:inline define:vars={{ lang, terminalData }}>
    function initTerminal() {
        const input = document.getElementById("terminal-input");
        const output = document.getElementById("terminal-output");
        if (!input || !output) return;

        const baseCommands = {
            clear: () => "__CLEAR__",
        };

        const commands = { ...baseCommands };

        // Inject dynamic commands from markdown files
        Object.keys(terminalData).forEach((cmd) => {
            commands[cmd] = () => terminalData[cmd];
        });

        // Ensure whoami is present if not already added via markdown
        if (!commands["whoami"]) {
            commands["whoami"] = () => "";
        }

        input.addEventListener("keydown", (e) => {
            if (e.key !== "Enter") return;
            const cmd = input.value.trim().toLowerCase();
            if (!cmd) return;

            // Add the command line
            const cmdLine = document.createElement("div");
            cmdLine.className = "terminal-line";
            cmdLine.innerHTML = `<span class="prompt">$</span> <span>${cmd}</span>`;
            output.appendChild(cmdLine);

            // Process command
            const handler = commands[cmd];
            if (handler) {
                const result = handler();
                if (result === "__CLEAR__") {
                    output.innerHTML = "";
                } else {
                    const response = document.createElement("div");
                    response.className = "terminal-response";
                    response.innerHTML = result;
                    output.appendChild(response);
                }
            } else {
                const err = document.createElement("div");
                err.className = "terminal-response terminal-error";
                err.textContent = `command not found: ${cmd}. Type 'help' for available commands.`;
                output.appendChild(err);
            }

            input.value = "";
            output.scrollTop = output.scrollHeight;
        });

        // Auto-typing animation
        const typedEl = document.getElementById("auto-typed");
        if (typedEl) {
            typedEl.style.width = "0";
            typedEl.style.overflow = "hidden";
            typedEl.style.whiteSpace = "nowrap";
            typedEl.style.display = "inline-block";
            typedEl.style.borderRight = "2px solid var(--color-accent-cyan)";

            let i = 0;
            const text = "whoami";
            typedEl.textContent = "";

            setTimeout(() => {
                const type = () => {
                    if (i < text.length) {
                        typedEl.textContent += text[i];
                        i++;
                        setTimeout(type, 100);
                    } else {
                        setTimeout(() => {
                            typedEl.style.borderRight = "none";
                            typedEl.style.width = "auto";
                        }, 500);
                    }
                };
                type();
            }, 600);
        }

        input.focus();
    }

    document.addEventListener("DOMContentLoaded", initTerminal);
    document.addEventListener("astro:page-load", initTerminal);
</script>

<style>
    .terminal {
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-lg), var(--shadow-glow);
        max-width: 720px;
        width: 100%;
        animation: fadeInUp 0.8s ease-out 0.3s both;
    }
    .terminal-bar {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        padding: 0.75rem 1rem;
        background: rgba(30, 41, 59, 0.9);
        border-bottom: 1px solid var(--color-border);
    }
    .terminal-buttons {
        display: flex;
        gap: 8px;
    }
    .terminal-btn {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    .terminal-btn.close {
        background: #ff5f57;
    }
    .terminal-btn.minimize {
        background: #febc2e;
    }
    .terminal-btn.maximize {
        background: #28c840;
    }
    .terminal-title {
        font-family: var(--font-mono);
        font-size: 0.75rem;
        color: var(--color-text-muted);
    }
    .terminal-body {
        padding: 1rem 1.25rem;
        max-height: 350px;
        overflow-y: auto;
        font-family: var(--font-mono);
        font-size: 0.85rem;
        line-height: 1.6;
        color: var(--color-text-secondary);
        scrollbar-width: thin;
    }
    .terminal-line {
        display: flex;
        gap: 0.5em;
        margin-bottom: 0.25rem;
    }
    .prompt {
        color: var(--color-accent-green);
        font-weight: 700;
        user-select: none;
    }
    .typed-text {
        color: var(--color-text-primary);
    }
    .terminal-response {
        margin: 0.25rem 0 0.75rem 1.2em;
        color: var(--color-text-secondary);
    }
    .terminal-response :global(pre) {
        font-family: var(--font-mono);
        font-size: 0.8rem;
        white-space: pre-wrap;
        word-break: break-word;
        margin: 0;
    }
    .terminal-response :global(ul) {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .terminal-response :global(li) {
        margin-bottom: 0.5rem;
        display: flex;
        gap: 0.5rem;
    }
    .terminal-response :global(li)::before {
        content: "âžœ";
        color: var(--color-accent-blue);
        flex-shrink: 0;
    }
    .terminal-response :global(p) {
        margin: 0 0 0.5rem 0;
    }
    .terminal-response :global(strong) {
        color: var(--color-accent-cyan);
    }
    .terminal-response :global(em) {
        color: var(--color-text-muted);
        font-style: italic;
        font-size: 0.75rem;
    }
    .terminal-error {
        color: var(--color-accent-orange);
    }
    .terminal-input-row {
        display: flex;
        gap: 0.5em;
        padding: 0.75rem 1.25rem;
        border-top: 1px solid var(--color-border);
        background: rgba(10, 25, 47, 0.5);
    }
    .terminal-input {
        flex: 1;
        background: none;
        border: none;
        outline: none;
        color: var(--color-text-primary);
        font-family: var(--font-mono);
        font-size: 0.85rem;
        caret-color: var(--color-accent-cyan);
    }
    .terminal-input::placeholder {
        color: var(--color-text-muted);
    }

    @media (max-width: 640px) {
        .terminal-body {
            max-height: 260px;
            font-size: 0.75rem;
        }
        .terminal-response :global(pre) {
            font-size: 0.7rem;
        }
    }
</style>
